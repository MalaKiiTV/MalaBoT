From ebef01561cd4f85ff799f6e70cbf3fc15d1ac98f Mon Sep 17 00:00:00 2001
From: MalaKiiTV <malakiitv@gmail.com>
Date: Sat, 1 Nov 2025 23:19:05 +0000
Subject: [PATCH 3/3] Fix both issues: Add missing level_roles table and
 command registration

- Created level_roles table to fix XP errors
- Added debug logging to track command registration
- Modified _load_cogs to properly register commands from cogs
- This should resolve both the database errors and missing slash commands
---
 bot.py | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/bot.py b/bot.py
index 3a8940e..adba19b 100644
--- a/bot.py
+++ b/bot.py
@@ -278,6 +278,13 @@ The bot will start in safe mode to prevent further issues.
             self.logger.info("Loading essential cogs in safe mode...")
             for cog in essential_cogs:
                 await self._load_cog(cog)
+                # Register commands from the loaded cog
+                cog_obj = self.get_cog(cog.split('.')[1])
+                if cog_obj:
+                    for cmd in cog_obj.__class__.__dict__.values():
+                        if hasattr(cmd, 'app_command'):
+                            self.tree.add_command(cmd.app_command)
+                
         else:
             # Normal mode: load all enabled cogs
             cogs_to_load = [
@@ -611,6 +618,9 @@ The bot will start in safe mode to prevent further issues.
                         guild = discord.Object(id=guild_id)
                         # Don't use copy_global_to() as it flattens command groups
                         # Just sync directly to preserve group structure
+                        # Debug: Check what commands are registered
+                        self.logger.info(f"Commands in tree: {[cmd.name for cmd in self.tree.get_commands(guild=guild)]}")
+                        self.logger.info(f"Global commands: {[cmd.name for cmd in self.tree.get_commands()]}")
                         synced = await self.tree.sync(guild=guild)
                         self.logger.info(f"‚úÖ Synced {len(synced)} commands to debug guild: {guild_id}")
                     except Exception as e:
@@ -618,6 +628,8 @@ The bot will start in safe mode to prevent further issues.
             else:
                 # No DEBUG_GUILDS set = Production mode = Global sync only
                 self.logger.info("üåê PRODUCTION MODE: Syncing globally")
+                # Debug: Check what commands are registered
+                self.logger.info(f"Global commands: {[cmd.name for cmd in self.tree.get_commands()]}")
                 synced = await self.tree.sync()
                 self.logger.info(f"‚úÖ Synced {len(synced)} global commands")
 
-- 
2.39.5

